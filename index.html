<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç‹¼äººæ®ºç­†è¨˜</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* åŸºæœ¬æ¨£å¼è¨­å®š */
        body {
            font-family: 'Noto Sans TC', sans-serif;
            overscroll-behavior: none; /* é˜²æ­¢æ»‘å‹•æ™‚è§¸ç™¼ç€è¦½å™¨å˜…å…¶ä»–è¡Œç‚º */
            -webkit-tap-highlight-color: transparent; /* é»æ“Šæ™‚å””æœƒæœ‰é«˜äº®æ•ˆæœ */
        }

        /* å›ºå®šç•«é¢ï¼Œé˜²æ­¢æ»¾å‹• */
        html, body {
            height: 100%;
            overflow: hidden;
        }
        
        /* ç©å®¶å¡ç‰‡å˜…æœ€å°é«˜åº¦ */
        .player-card {
            min-height: 6.5vh; /* Final reduced height */
            transition: background-color 0.2s ease-in-out;
            position: relative; /* For the cross overlay */
        }

        /* æ¨™ç±¤å˜…æ¨£å¼ */
        .tag {
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.7rem;
            margin: 1px;
            font-weight: 500;
            background-color: #4b5563; /* çµ±ä¸€æ¨™ç±¤é¡è‰² */
            color: white;
        }
        
        /* Modal å‹•ç•« */
        .modal.hidden { display: none; }
        .modal-backdrop { transition: opacity 0.2s ease-in-out; }
        .modal-content { transition: transform 0.2s ease-in-out, opacity 0.2s ease-in-out; }
        .modal.modal-closed .modal-backdrop { opacity: 0; }
        .modal.modal-closed .modal-content { opacity: 0; transform: scale(0.95); }

        /* Modal å…§æŒ‰éˆ•é¸ä¸­æ™‚çš„æ¨£å¼ */
        .sheriff-player-btn.selected, .vote-btn.selected, #set-me-btn.selected, #set-good-person-btn.selected, #set-wolf-slot-btn.selected, #set-star-btn.selected {
            filter: brightness(1.2);
            box-shadow: 0 0 0 2px white;
        }
        .tag-btn.selected {
            background-color: #2563eb; /* blue-600 */
            box-shadow: 0 0 0 2px white;
        }
        
        /* ç©å®¶å‡ºå±€æ™‚çš„æ¨£å¼ */
        .player-card.eliminated > .card-content {
            opacity: 0.6; 
        }
        .player-card.eliminated::before,
        .player-card.eliminated::after {
             content: '';
             position: absolute;
             top: 50%;
             left: 15%;
             right: 15%;
             height: 6px;
             background-color: #dc2626;
             border-radius: 3px;
             z-index: 20;
        }
        .player-card.eliminated::before {
             transform: translateY(-50%) rotate(45deg);
        }
         .player-card.eliminated::after {
             transform: translateY(-50%) rotate(-45deg);
        }
        
        /* å°‡ç©å®¶æ¨™è¨˜ç‚ºç‹¼äººæ™‚ï¼Œæ•´å€‹æ–¹å¡Šè®Šç´…è‰² */
        .player-card.is-wolf-slot {
            background-color: #450a0a;
        }
        /* å°‡ç©å®¶æ¨™è¨˜ç‚ºå¥½äººæ™‚ï¼Œæ•´å€‹æ–¹å¡Šè®Šç¶ è‰² */
        .player-card.is-good-person {
            background-color: #064e3b;
        }

        /* è­¦é•·æŠ•ç¥¨é¸æ“‡å™¨ */
        .vote-select {
            background-color: #4b5563;
            border: 1px solid #6b7280;
            border-radius: 6px;
            padding: 4px 6px;
            color: white;
            font-size: 0.9rem;
        }

    </style>
</head>
<body class="bg-gray-900 text-white select-none">

    <!-- ä¸»æ‡‰ç”¨ç¨‹å¼å®¹å™¨ -->
    <div id="app" class="h-full flex flex-col p-2 max-w-md mx-auto">

        <!-- é ‚éƒ¨æ¨™é¡Œå’ŒæŒ‰éˆ• -->
        <header class="flex justify-end items-center mb-2 px-2 flex-shrink-0">
            <div class="space-x-1 flex items-center">
                <button id="sheriff-btn" class="text-xs bg-blue-800 hover:bg-blue-700 text-white font-bold py-2 px-3 rounded-lg">è­¦é•·é¸èˆ‰</button>
                <button id="tie-breaker-btn" class="text-xs bg-purple-800 hover:bg-purple-700 text-white font-bold py-2 px-3 rounded-lg">å¹³ç¥¨PK</button>
                <button id="reset-btn" class="bg-red-800 hover:bg-red-700 text-white font-bold p-2 rounded-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"></polyline><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path></svg>
                </button>
            </div>
        </header>

        <!-- è­¦é•·é¸èˆ‰è³‡è¨Šé¡¯ç¤ºå€ -->
        <section id="sheriff-display" class="text-xs px-2 mb-2 text-gray-300 space-y-1 flex-shrink-0"></section>
        <!-- å¹³ç¥¨PKè³‡è¨Šé¡¯ç¤ºå€ -->
        <section id="tie-breaker-display" class="text-xs px-2 mb-2 text-gray-300 space-y-1 flex-shrink-0"></section>

        <!-- ç©å®¶æ ¼ä»”ä½ˆå±€ -->
        <main id="players-grid" class="flex gap-2 flex-grow">
            <div id="left-column" class="flex flex-col gap-2 w-1/2"></div>
            <div id="right-column" class="flex flex-col gap-2 w-1/2"></div>
        </main>
    </div>

    <!-- æ¨™è¨˜èº«ä»½ Modal -->
    <div id="modal" class="modal fixed inset-0 z-50 flex items-center justify-center p-4 hidden modal-closed">
        <div id="modal-backdrop" class="absolute inset-0 bg-black bg-opacity-70"></div>
        <div id="modal-content" class="modal-content relative bg-gray-800 rounded-2xl w-full max-w-sm p-5 shadow-lg">
            <h2 id="modal-title" class="text-lg font-bold text-center mb-4"></h2>
            <div id="modal-options"></div>
            <div id="tags-options" class="space-y-4"></div>
            <button id="close-modal-btn" class="absolute top-2 right-2 text-gray-400 hover:text-white">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>
    </div>

    <!-- å¹³ç¥¨PK Modal -->
    <div id="tie-breaker-modal" class="modal fixed inset-0 z-50 flex items-center justify-center p-4 hidden modal-closed">
        <div id="tie-breaker-modal-backdrop" class="modal-backdrop absolute inset-0 bg-black bg-opacity-70"></div>
        <div id="tie-breaker-modal-content" class="modal-content relative bg-gray-800 rounded-2xl w-full max-w-sm p-5 shadow-lg flex flex-col h-[90vh]">
            <h2 class="text-lg font-bold text-center mb-4 flex-shrink-0">å¹³ç¥¨PKè¨­å®š</h2>
            <div id="tie-breaker-options" class="flex-grow overflow-y-auto"></div>
            <div class="mt-4 flex space-x-2 flex-shrink-0">
                <button id="reset-tie-breaker-btn" class="w-1/2 bg-red-800 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">é‡è¨­PK</button>
                <button id="close-tie-breaker-btn" class="w-1/2 bg-purple-700 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded-lg">å®Œæˆ</button>
            </div>
        </div>
    </div>

    <!-- è­¦é•·é¸èˆ‰ Modal -->
    <div id="sheriff-modal" class="modal fixed inset-0 z-50 flex items-center justify-center p-4 hidden modal-closed">
        <div id="sheriff-modal-backdrop" class="modal-backdrop absolute inset-0 bg-black bg-opacity-70"></div>
        <div id="sheriff-modal-content" class="modal-content relative bg-gray-800 rounded-2xl w-full max-w-sm p-5 shadow-lg flex flex-col h-[90vh]">
            <h2 class="text-lg font-bold text-center mb-4 flex-shrink-0">è­¦é•·é¸èˆ‰è¨­å®š</h2>
            <div id="sheriff-options" class="flex-grow overflow-y-auto"></div>
            <div class="mt-4 flex space-x-2 flex-shrink-0">
                <button id="reset-sheriff-btn" class="w-1/2 bg-red-800 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">é‡è¨­è­¦é¸</button>
                <button id="close-sheriff-modal-btn" class="w-1/2 bg-blue-700 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">å®Œæˆ</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const app = document.getElementById('app');

            // --- Viewport Height Fix ---
            function setAppHeight() {
                app.style.height = `${window.innerHeight}px`;
            }
            // Set height on initial load and on resize
            setAppHeight();
            window.addEventListener('resize', setAppHeight);

            // DOM element selections
            const leftColumn = document.getElementById('left-column');
            const rightColumn = document.getElementById('right-column');
            const modal = document.getElementById('modal');
            const modalBackdrop = document.getElementById('modal-backdrop');
            const modalTitle = document.getElementById('modal-title');
            const modalOptions = document.getElementById('modal-options');
            const tagsOptions = document.getElementById('tags-options');
            const closeModalBtn = document.getElementById('close-modal-btn');
            const resetBtn = document.getElementById('reset-btn');
            const sheriffBtn = document.getElementById('sheriff-btn');
            const sheriffModal = document.getElementById('sheriff-modal');
            const sheriffModalBackdrop = document.getElementById('sheriff-modal-backdrop');
            const sheriffOptions = document.getElementById('sheriff-options');
            const closeSheriffModalBtn = document.getElementById('close-sheriff-modal-btn');
            const resetSheriffBtn = document.getElementById('reset-sheriff-btn');
            const sheriffDisplay = document.getElementById('sheriff-display');
            const tieBreakerBtn = document.getElementById('tie-breaker-btn');
            const tieBreakerModal = document.getElementById('tie-breaker-modal');
            const tieBreakerModalBackdrop = document.getElementById('tie-breaker-modal-backdrop');
            const tieBreakerOptions = document.getElementById('tie-breaker-options');
            const closeTieBreakerBtn = document.getElementById('close-tie-breaker-btn');
            const resetTieBreakerBtn = document.getElementById('reset-tie-breaker-btn');
            const tieBreakerDisplay = document.getElementById('tie-breaker-display');

            let gameState = {};
            let currentEditingPlayerId = null;

            // Tags configuration
            const tagDefinitions = {
                'ç‹¼': { name: 'ç‹¼' }, 'å¤§ç‹¼': { name: 'å¤§ç‹¼' }, 'å…¶ä»–ç‹¼': { name: 'å…¶ä»–ç‹¼' },
                'é è¨€å®¶': { name: 'é è¨€å®¶' }, 'å¥³å·«': { name: 'å¥³å·«' }, 'çµäºº': { name: 'çµäºº' }, 'ç¥ç‰Œ': { name: 'ç¥ç‰Œ' },
                'åå¥½': { name: 'åå¥½' }, 'å¹³æ°‘': { name: 'å¹³æ°‘' }, 'é‡‘æ°´': { name: 'é‡‘æ°´' }, 'éŠ€æ°´': { name: 'éŠ€æ°´' },
                'å¥½äºº': { name: 'å¥½äºº', isGoodPerson: true }, 'ç‹¼äºº': { name: 'ç‹¼äºº', isWolfSlot: true },
            };
            const tagLayout = [
                ['ç‹¼', 'å¤§ç‹¼', 'å…¶ä»–ç‹¼'], ['é è¨€å®¶', 'å¥³å·«', 'çµäºº', 'ç¥ç‰Œ'], ['åå¥½', 'å¹³æ°‘', 'é‡‘æ°´', 'éŠ€æ°´']
            ];

            function initialize() {
                const savedData = localStorage.getItem('werewolfNotepadState');
                if (savedData) {
                    gameState = JSON.parse(savedData);
                    if (!gameState.sheriff) gameState.sheriff = { running: [], votes: {} };
                    if (!gameState.sheriffTieBreaker) gameState.sheriffTieBreaker = { tiedPlayers: [], votes: {} };
                    gameState.players.forEach(p => {
                        if (p.isMe === undefined) p.isMe = false;
                        if (p.isStarred === undefined) p.isStarred = false;
                    });
                } else {
                    gameState = {
                        players: Array.from({ length: 12 }, (_, i) => ({ id: i + 1, status: 'alive', tags: [], isMe: false, isStarred: false })),
                        sheriff: { running: [], votes: {} },
                        sheriffTieBreaker: { tiedPlayers: [], votes: {} },
                    };
                }
                render();
            }

            function saveData() {
                localStorage.setItem('werewolfNotepadState', JSON.stringify(gameState));
            }

            function render() {
                renderPlayers();
                renderSheriffInfo();
                renderTieBreakerInfo();
            }

            function renderPlayers() {
                leftColumn.innerHTML = '';
                rightColumn.innerHTML = '';
                gameState.players.forEach(player => {
                    const isWolfSlot = player.tags.includes('ç‹¼äºº');
                    const isGoodPerson = player.tags.includes('å¥½äºº');
                    const card = document.createElement('div');
                    let cardClasses = `player-card bg-gray-800 rounded-lg p-2 flex flex-col justify-start ${player.status === 'eliminated' ? 'eliminated' : ''}`;
                    if (isWolfSlot) cardClasses += ' is-wolf-slot';
                    else if (isGoodPerson) cardClasses += ' is-good-person';
                    card.className = cardClasses;
                    card.dataset.playerId = player.id;
                    const tagsHTML = player.tags.filter(t => t !== 'å¥½äºº' && t !== 'ç‹¼äºº').map(t => tagDefinitions[t] ? `<span class="tag">${t}</span>` : '').join('');
                    const isLeft = player.id <= 6;
                    const meEmojiHTML = player.isMe ? `<span class="absolute ${isLeft ? 'bottom-1 left-1' : 'bottom-1 right-1'} text-xl z-10">ğŸ™ğŸ»â€â™‚ï¸</span>` : '';
                    const starHTML = player.isStarred ? `<span class="absolute top-0 right-0 text-lg z-10 transform -translate-y-1/4 translate-x-1/4">â˜€ï¸</span>` : '';
                    card.innerHTML = `
                        <div class="card-content w-full">
                            <div class="flex justify-between items-center w-full relative mb-1">
                                <button class="reset-player-btn text-gray-500 hover:text-white z-10 p-1">
                                   <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"></polyline><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path></svg>
                                </button>
                                <div class="player-number-wrapper relative">
                                    <div class="player-number text-4xl font-bold">${player.id}</div>
                                    ${starHTML}
                                </div>
                                <button class="eliminate-btn text-gray-500 hover:text-white z-10 p-1">
                                     <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
                                </button>
                            </div>
                            <div class="tags-container flex flex-wrap justify-center min-h-[28px] items-center">${tagsHTML}</div>
                        </div>
                        ${meEmojiHTML}
                    `;
                    if (isLeft) leftColumn.appendChild(card);
                    else rightColumn.appendChild(card);
                });
            }

            function renderSheriffInfo() {
                const { running, votes } = gameState.sheriff;
                if (running.length === 0 && Object.keys(votes).length === 0) {
                    sheriffDisplay.innerHTML = ''; return;
                }
                const notRunning = gameState.players.map(p => p.id).filter(id => !running.includes(id));
                
                const runningText = running.length > 0 ? `<span class="font-semibold">è­¦ä¸Šï¼š</span>${running.join(' ')}` : '';
                const notRunningText = notRunning.length > 0 ? `<span class="font-semibold ml-2">è­¦ä¸‹ï¼š</span>${notRunning.join(' ')}` : '';
                const combinedRunningText = `<div>${runningText}${notRunningText}</div>`;

                const votesByCandidate = {};
                notRunning.forEach(voterId => {
                    const votedFor = votes[voterId];
                    const candidate = votedFor ? votedFor : 'abstain';
                    if (!votesByCandidate[candidate]) votesByCandidate[candidate] = [];
                    votesByCandidate[candidate].push(String(voterId));
                });
                let votesText = '';
                if (notRunning.length > 0) {
                    votesText += '<div><span class="font-semibold">æŠ•ç¥¨ï¼š</span>';
                    const voteStrings = [];
                    const sortedCandidates = Object.keys(votesByCandidate).sort((a, b) => {
                        if (a === 'abstain') return 1; if (b === 'abstain') return -1;
                        return parseInt(a) - parseInt(b);
                    });
                    sortedCandidates.forEach(candidate => {
                        const voters = votesByCandidate[candidate];
                        if (voters && voters.length > 0) {
                            const sortedVoters = voters.sort((a,b) => parseInt(a) - parseInt(b)).join(' ');
                            if (candidate === 'abstain') voteStrings.push(`${sortedVoters} æ£„ç¥¨`);
                            else voteStrings.push(`${sortedVoters} æŠ• ${candidate}`);
                        }
                    });
                    votesText += voteStrings.join('ï¼› ');
                    votesText += '</div>';
                }
                sheriffDisplay.innerHTML = combinedRunningText + votesText;
            }

            function renderTieBreakerInfo() {
                const { tiedPlayers, votes } = gameState.sheriffTieBreaker;
                if (tiedPlayers.length === 0) {
                    tieBreakerDisplay.innerHTML = ''; return;
                }
                let html = '<div class="border-t border-gray-700 mt-2 pt-2">';
                html += `<div><span class="font-semibold text-purple-400">å¹³ç¥¨PKç©å®¶ï¼š</span>${tiedPlayers.join(' ')}</div>`;
                const votesByCandidate = {};
                Object.entries(votes).forEach(([voter, candidate]) => {
                    if (candidate) {
                        if (!votesByCandidate[candidate]) votesByCandidate[candidate] = [];
                        votesByCandidate[candidate].push(voter);
                    }
                });
                const allPossibleVoters = gameState.players.filter(p => !tiedPlayers.includes(p.id)).map(p => p.id);
                const actualVoters = Object.keys(votes).map(v => parseInt(v));
                const abstainers = allPossibleVoters.filter(voterId => !actualVoters.includes(voterId));
                if (actualVoters.length > 0 || abstainers.length > 0) {
                    html += `<div><span class="font-semibold text-purple-400">PKæŠ•ç¥¨ï¼š</span>`;
                    const voteStrings = [];
                    Object.entries(votesByCandidate).forEach(([candidate, voters]) => {
                        voteStrings.push(`${voters.sort((a,b) => a-b).join(' ')} æŠ• ${candidate}`);
                    });
                    if (abstainers.length > 0) {
                        voteStrings.push(`${abstainers.sort((a,b) => a-b).join(' ')} æ£„ç¥¨`);
                    }
                    html += voteStrings.join('ï¼› ');
                    html += `</div>`;
                }
                html += '</div>';
                tieBreakerDisplay.innerHTML = html;
            }

            function openGenericModal(modalElement) {
                modalElement.classList.remove('hidden');
                setTimeout(() => modalElement.classList.remove('modal-closed'), 10);
            }
            function closeGenericModal(modalElement) {
                modalElement.classList.add('modal-closed');
                setTimeout(() => modalElement.classList.add('hidden'), 200);
            }

            function openTagModal(playerId) {
                currentEditingPlayerId = playerId;
                const player = gameState.players.find(p => p.id === playerId);
                if (!player) return;
                modalTitle.textContent = `æ¨™è¨˜ ${playerId} è™Ÿç©å®¶`;
                modalOptions.innerHTML = `
                    <div class="flex space-x-2 mb-4 border-b border-gray-700 pb-3">
                        <button id="set-me-btn" class="w-1/4 py-2 px-2 rounded-lg text-white font-semibold text-2xl ${player.isMe ? 'bg-green-600 selected' : 'bg-gray-600'}">ğŸ™ğŸ»â€â™‚ï¸</button>
                        <button id="set-star-btn" class="w-1/4 py-2 px-2 rounded-lg text-white font-semibold text-2xl ${player.isStarred ? 'bg-yellow-600 selected' : 'bg-gray-600'}">â˜€ï¸</button>
                        <button id="set-good-person-btn" class="w-1/4 py-2 px-2 rounded-lg text-white font-semibold ${player.tags.includes('å¥½äºº') ? 'bg-green-700 selected' : 'bg-gray-600'}">å¥½äºº</button>
                        <button id="set-wolf-slot-btn" class="w-1/4 py-2 px-2 rounded-lg text-white font-semibold ${player.tags.includes('ç‹¼äºº') ? 'bg-red-800 selected' : 'bg-gray-600'}">ç‹¼äºº</button>
                    </div>`;
                tagsOptions.innerHTML = tagLayout.map(row => `
                    <div class="flex flex-wrap justify-center gap-2">
                        ${row.map(tagId => `
                            <button class="tag-btn bg-gray-600 hover:bg-gray-500 text-white font-medium py-2 px-3 rounded-lg text-sm flex-grow ${player.tags.includes(tagId) ? 'selected' : ''}" data-tag-id="${tagId}">
                                ${tagDefinitions[tagId].name}
                            </button>
                        `).join('')}
                    </div>`).join('');
                openGenericModal(modal);
            }
            
            function openSheriffModal() {
                renderSheriffModalContent();
                openGenericModal(sheriffModal);
            }
            function openTieBreakerModal() {
                renderTieBreakerModalContent();
                openGenericModal(tieBreakerModal);
            }

            function renderSheriffModalContent() {
                sheriffOptions.innerHTML = '';
                const { running } = gameState.sheriff;
                const runningSection = document.createElement('div');
                runningSection.innerHTML = `<h3 class="text-md font-bold text-yellow-400 mb-2 border-b border-gray-600 pb-1">è­¦ä¸Šç©å®¶</h3>`;
                const runningGrid = document.createElement('div');
                runningGrid.className = 'grid grid-cols-4 gap-2 mb-4';
                gameState.players.forEach(p => {
                    const btn = document.createElement('button');
                    btn.className = `sheriff-player-btn py-2 rounded-lg ${running.includes(p.id) ? 'bg-yellow-600 selected' : 'bg-gray-600'}`;
                    btn.textContent = p.id;
                    btn.dataset.playerId = p.id;
                    runningGrid.appendChild(btn);
                });
                runningSection.appendChild(runningGrid);
                sheriffOptions.appendChild(runningSection);
                const notRunningPlayers = gameState.players.filter(p => !running.includes(p.id));
                if (notRunningPlayers.length > 0) {
                    const votingSection = document.createElement('div');
                    votingSection.innerHTML = `<h3 class="text-md font-bold text-blue-400 mb-2 border-b border-gray-600 pb-1">è­¦ä¸‹æŠ•ç¥¨</h3>`;
                    const votingList = document.createElement('div');
                    votingList.className = 'space-y-2';
                    notRunningPlayers.forEach(p => {
                        const voteItem = document.createElement('div');
                        voteItem.className = 'flex items-center justify-between';
                        voteItem.innerHTML = `<span class="font-bold mr-4">${p.id} è™Ÿ</span>`;
                        const select = document.createElement('select');
                        select.className = 'vote-select';
                        select.dataset.voterId = p.id;
                        select.innerHTML = `<option value="">æœªæŠ•ç¥¨</option>`;
                        running.forEach(candidateId => {
                           select.innerHTML += `<option value="${candidateId}" ${gameState.sheriff.votes[p.id] == candidateId ? 'selected' : ''}>æŠ• ${candidateId} è™Ÿ</option>`;
                        });
                        select.innerHTML += `<option value="abstain" ${gameState.sheriff.votes[p.id] === 'abstain' ? 'selected' : ''}>æ£„ç¥¨</option>`;
                        voteItem.appendChild(select);
                        votingList.appendChild(voteItem);
                    });
                    votingSection.appendChild(votingList);
                    sheriffOptions.appendChild(votingSection);
                }
            }
            
            function renderTieBreakerModalContent() {
                tieBreakerOptions.innerHTML = '';
                const { tiedPlayers, votes } = gameState.sheriffTieBreaker;
                const tiedSection = document.createElement('div');
                tiedSection.innerHTML = `<h3 class="text-md font-bold text-purple-400 mb-2 border-b border-gray-600 pb-1">PKç©å®¶</h3>`;
                const tiedGrid = document.createElement('div');
                tiedGrid.className = 'grid grid-cols-4 gap-2 mb-4';
                gameState.players.forEach(p => {
                    const btn = document.createElement('button');
                    btn.className = `sheriff-player-btn py-2 rounded-lg ${tiedPlayers.includes(p.id) ? 'bg-purple-600 selected' : 'bg-gray-600'}`;
                    btn.textContent = p.id;
                    btn.dataset.playerId = p.id;
                    tiedGrid.appendChild(btn);
                });
                tiedSection.appendChild(tiedGrid);
                tieBreakerOptions.appendChild(tiedSection);
                const voters = gameState.players.filter(p => !tiedPlayers.includes(p.id));
                if (voters.length > 0 && tiedPlayers.length > 0) {
                    const votingContainer = document.createElement('div');
                    tiedPlayers.forEach(candidateId => {
                        const candidateSection = document.createElement('div');
                        candidateSection.className = 'mb-4';
                        candidateSection.innerHTML = `<h3 class="text-md font-bold text-blue-400 mb-2 border-b border-gray-600 pb-1">æŠ•ç¥¨çµ¦ ${candidateId} è™Ÿ</h3>`;
                        const votersGrid = document.createElement('div');
                        votersGrid.className = 'grid grid-cols-5 gap-2';
                        voters.forEach(voter => {
                            const btn = document.createElement('button');
                            const isSelected = votes[voter.id] === candidateId;
                            btn.className = `vote-btn py-2 rounded-lg ${isSelected ? 'bg-blue-600 selected' : 'bg-gray-600'}`;
                            btn.textContent = voter.id;
                            btn.dataset.voterId = voter.id;
                            btn.dataset.candidateId = candidateId;
                            votersGrid.appendChild(btn);
                        });
                        candidateSection.appendChild(votersGrid);
                        votingContainer.appendChild(candidateSection);
                    });
                    tieBreakerOptions.appendChild(votingContainer);
                }
            }

            // Event Listeners
            document.getElementById('players-grid').addEventListener('click', e => {
                const card = e.target.closest('.player-card');
                if (!card) return;
                const playerId = parseInt(card.dataset.playerId);
                if (e.target.closest('.reset-player-btn')) {
                    const player = gameState.players.find(p => p.id === playerId);
                    if (player) {
                        player.tags = []; player.status = 'alive'; player.isMe = false; player.isStarred = false;
                        saveData(); render();
                    }
                } else if (e.target.closest('.eliminate-btn')) {
                    const player = gameState.players.find(p => p.id === playerId);
                    if (player) {
                        player.status = player.status === 'alive' ? 'eliminated' : 'alive';
                        saveData(); render();
                    }
                } else {
                    openTagModal(playerId);
                }
            });
            
            function toggleTag(tagId, player) {
                const index = player.tags.indexOf(tagId);
                if (index > -1) player.tags.splice(index, 1);
                else player.tags.push(tagId);
            }
            modal.addEventListener('click', e => {
                const player = gameState.players.find(p => p.id === currentEditingPlayerId);
                if (!player) return;
                const button = e.target.closest('button');
                if (!button) return;
                let shouldSave = true;
                const tagId = button.dataset.tagId;
                switch (button.id) {
                    case 'set-me-btn': player.isMe = !player.isMe; break;
                    case 'set-star-btn': player.isStarred = !player.isStarred; break;
                    case 'set-good-person-btn': toggleTag('å¥½äºº', player); break;
                    case 'set-wolf-slot-btn': toggleTag('ç‹¼äºº', player); break;
                    default:
                        if (tagId) toggleTag(tagId, player);
                        else shouldSave = false;
                }
                if (shouldSave) {
                    saveData();
                    openTagModal(currentEditingPlayerId);
                }
            });

            // Sheriff & PK Modal Events
            sheriffBtn.addEventListener('click', openSheriffModal);
            closeSheriffModalBtn.addEventListener('click', () => { saveData(); render(); closeGenericModal(sheriffModal); });
            sheriffModalBackdrop.addEventListener('click', () => { saveData(); render(); closeGenericModal(sheriffModal); });
            resetSheriffBtn.addEventListener('click', () => {
                gameState.sheriff = { running: [], votes: {} };
                gameState.sheriffTieBreaker = { tiedPlayers: [], votes: {} };
                renderSheriffModalContent();
            });
            sheriffOptions.addEventListener('click', e => {
                const btn = e.target.closest('.sheriff-player-btn');
                if (!btn) return;
                const playerId = parseInt(btn.dataset.playerId);
                const running = gameState.sheriff.running;
                const index = running.indexOf(playerId);
                if (index > -1) {
                    running.splice(index, 1);
                    Object.keys(gameState.sheriff.votes).forEach(voter => { if (gameState.sheriff.votes[voter] === playerId) delete gameState.sheriff.votes[voter]; });
                } else {
                    running.push(playerId); running.sort((a, b) => a - b);
                }
                renderSheriffModalContent();
            });
            sheriffOptions.addEventListener('change', e => {
                const select = e.target.closest('.vote-select');
                if (!select) return;
                const voterId = select.dataset.voterId;
                const candidate = select.value;
                if (candidate) gameState.sheriff.votes[voterId] = candidate === 'abstain' ? 'abstain' : parseInt(candidate);
                else delete gameState.sheriff.votes[voterId];
            });
            tieBreakerBtn.addEventListener('click', () => {
                const { votes } = gameState.sheriff;
                const voteCounts = {};
                Object.values(votes).forEach(c => { if (c && c !== 'abstain') voteCounts[c] = (voteCounts[c] || 0) + 1; });
                let maxVotes = 0;
                Object.values(voteCounts).forEach(c => { if (c > maxVotes) maxVotes = c; });
                const tiedPlayers = [];
                if (maxVotes > 0) {
                    Object.keys(voteCounts).forEach(c => { if (voteCounts[c] === maxVotes) tiedPlayers.push(parseInt(c)); });
                }
                if (tiedPlayers.length > 1) {
                    gameState.sheriffTieBreaker.tiedPlayers = tiedPlayers.sort((a,b) => a-b);
                    gameState.sheriffTieBreaker.votes = {};
                }
                openTieBreakerModal();
            });
            closeTieBreakerBtn.addEventListener('click', () => { saveData(); render(); closeGenericModal(tieBreakerModal); });
            tieBreakerModalBackdrop.addEventListener('click', () => { saveData(); render(); closeGenericModal(tieBreakerModal); });
            resetTieBreakerBtn.addEventListener('click', () => {
                gameState.sheriffTieBreaker = { tiedPlayers: [], votes: {} };
                renderTieBreakerModalContent();
            });
            tieBreakerOptions.addEventListener('click', e => {
                const playerBtn = e.target.closest('.sheriff-player-btn');
                if (playerBtn) {
                    const playerId = parseInt(playerBtn.dataset.playerId);
                    const tied = gameState.sheriffTieBreaker.tiedPlayers;
                    const index = tied.indexOf(playerId);
                    if (index > -1) {
                        tied.splice(index, 1);
                        Object.keys(gameState.sheriffTieBreaker.votes).forEach(v => { if(gameState.sheriffTieBreaker.votes[v] === playerId) delete gameState.sheriffTieBreaker.votes[v]; });
                    } else {
                        tied.push(playerId); tied.sort((a, b) => a - b);
                    }
                    renderTieBreakerModalContent();
                }
                const voteBtn = e.target.closest('.vote-btn');
                if (voteBtn) {
                    const voterId = parseInt(voteBtn.dataset.voterId);
                    const candidateId = parseInt(voteBtn.dataset.candidateId);
                    const votes = gameState.sheriffTieBreaker.votes;
                    if (votes[voterId] === candidateId) delete votes[voterId];
                    else votes[voterId] = candidateId;
                    renderTieBreakerModalContent();
                }
            });
            
            // General Listeners
            closeModalBtn.addEventListener('click', () => { render(); closeGenericModal(modal); });
            modalBackdrop.addEventListener('click', () => { render(); closeGenericModal(modal); });
            resetBtn.addEventListener('click', () => { localStorage.removeItem('werewolfNotepadState'); initialize(); });

            initialize();
        });
    </script>
</body>
</html>
