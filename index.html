<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>狼人殺筆記</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* 基本樣式設定 */
        body {
            font-family: 'Noto Sans TC', sans-serif;
            overscroll-behavior: none; /* 防止滑動時觸發瀏覽器嘅其他行為 */
            -webkit-tap-highlight-color: transparent; /* 點擊時唔會有高亮效果 */
        }

        /* 固定畫面，防止滾動 */
        html, body {
            height: 100%;
            overflow: hidden;
        }
        
        /* 玩家卡片嘅最小高度，確保喺唔同手機上佈局穩定 */
        .player-card {
            min-height: 11vh;
            transition: background-color 0.2s ease-in-out;
            position: relative; /* For the cross overlay */
        }

        /* 標籤嘅樣式 */
        .tag {
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.7rem;
            margin: 1px;
            font-weight: 500;
            background-color: #4b5563; /* 統一標籤顏色 */
            color: white;
        }
        
        /* Modal 動畫 */
        .modal.hidden { display: none; }
        .modal-backdrop { transition: opacity 0.2s ease-in-out; }
        .modal-content { transition: transform 0.2s ease-in-out, opacity 0.2s ease-in-out; }
        .modal.modal-closed .modal-backdrop { opacity: 0; }
        .modal.modal-closed .modal-content { opacity: 0; transform: scale(0.95); }

        /* Modal 內按鈕選中時的樣式 */
        .sheriff-player-btn.selected, .vote-btn.selected, #set-me-btn.selected, #set-good-person-btn.selected, #set-wolf-slot-btn.selected, #set-star-btn.selected {
            filter: brightness(1.2);
            box-shadow: 0 0 0 2px white;
        }
        .tag-btn.selected {
            background-color: #2563eb; /* blue-600 */
            box-shadow: 0 0 0 2px white;
        }
        
        /* 玩家出局時的樣式 */
        .player-card.eliminated > * {
            opacity: 0.6; /* Dim the content inside the card */
        }
        .player-card.eliminated::before,
        .player-card.eliminated::after {
             content: '';
             position: absolute;
             top: 50%;
             left: 15%;
             right: 15%;
             height: 6px;
             background-color: #dc2626;
             border-radius: 3px;
             z-index: 20;
        }
        .player-card.eliminated::before {
             transform: translateY(-50%) rotate(45deg);
        }
         .player-card.eliminated::after {
             transform: translateY(-50%) rotate(-45deg);
        }
        
        .player-number-wrapper {
            position: relative;
        }
        .player-number {
             display: flex;
             align-items: center;
             justify-content: center;
        }

        /* 將玩家標記為狼人時，整個方塊變紅色 */
        .player-card.is-wolf-slot {
            background-color: #450a0a;
        }
        /* 將玩家標記為好人時，整個方塊變綠色 */
        .player-card.is-good-person {
            background-color: #064e3b;
        }

        /* 警長投票選擇器 */
        .vote-select {
            background-color: #4b5563;
            border: 1px solid #6b7280;
            border-radius: 6px;
            padding: 4px 6px;
            color: white;
            font-size: 0.9rem;
        }

    </style>
</head>
<body class="bg-gray-900 text-white select-none">

    <!-- 主應用程式容器 -->
    <div id="app" class="h-full flex flex-col p-2 max-w-md mx-auto">

        <!-- 頂部標題和按鈕 -->
        <header class="flex justify-end items-center mb-2 px-2">
            <div class="space-x-1 flex items-center">
                <button id="sheriff-btn" class="text-xs bg-blue-800 hover:bg-blue-700 text-white font-bold py-2 px-3 rounded-lg">警長選舉</button>
                <button id="tie-breaker-btn" class="text-xs bg-purple-800 hover:bg-purple-700 text-white font-bold py-2 px-3 rounded-lg">平票PK</button>
                <button id="reset-btn" class="bg-red-800 hover:bg-red-700 text-white font-bold p-2 rounded-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 18"/><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1-6.74-2.74L21 6"/><path d="M3 6h6v6"/><path d="M21 18h-6v-6"/></svg>
                </button>
            </div>
        </header>

        <!-- 警長選舉資訊顯示區 -->
        <section id="sheriff-display" class="text-xs px-2 mb-2 text-gray-300 space-y-1"></section>
        <!-- 平票PK資訊顯示區 -->
        <section id="tie-breaker-display" class="text-xs px-2 mb-2 text-gray-300 space-y-1"></section>

        <!-- 玩家格仔佈局 -->
        <main id="players-grid" class="flex gap-2 flex-grow">
            <div id="left-column" class="flex flex-col gap-2 w-1/2"></div>
            <div id="right-column" class="flex flex-col gap-2 w-1/2"></div>
        </main>
    </div>

    <!-- 標記身份 Modal -->
    <div id="modal" class="modal fixed inset-0 z-50 flex items-center justify-center p-4 hidden modal-closed">
        <div id="modal-backdrop" class="absolute inset-0 bg-black bg-opacity-70"></div>
        <div id="modal-content" class="modal-content relative bg-gray-800 rounded-2xl w-full max-w-sm p-5 shadow-lg">
            <h2 id="modal-title" class="text-lg font-bold text-center mb-4"></h2>
            <div id="modal-options"></div>
            <div id="tags-options" class="space-y-4"></div>
            <button id="close-modal-btn" class="absolute top-2 right-2 text-gray-400 hover:text-white">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>
    </div>

    <!-- 平票PK Modal -->
    <div id="tie-breaker-modal" class="modal fixed inset-0 z-50 flex items-center justify-center p-4 hidden modal-closed">
        <div id="tie-breaker-modal-backdrop" class="modal-backdrop absolute inset-0 bg-black bg-opacity-70"></div>
        <div id="tie-breaker-modal-content" class="modal-content relative bg-gray-800 rounded-2xl w-full max-w-sm p-5 shadow-lg flex flex-col h-[90vh]">
            <h2 class="text-lg font-bold text-center mb-4 flex-shrink-0">平票PK設定</h2>
            <div id="tie-breaker-options" class="flex-grow overflow-y-auto"></div>
            <div class="mt-4 flex space-x-2 flex-shrink-0">
                <button id="reset-tie-breaker-btn" class="w-1/2 bg-red-800 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">重設PK</button>
                <button id="close-tie-breaker-btn" class="w-1/2 bg-purple-700 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded-lg">完成</button>
            </div>
        </div>
    </div>

    <!-- 警長選舉 Modal -->
    <div id="sheriff-modal" class="modal fixed inset-0 z-50 flex items-center justify-center p-4 hidden modal-closed">
        <div id="sheriff-modal-backdrop" class="modal-backdrop absolute inset-0 bg-black bg-opacity-70"></div>
        <div id="sheriff-modal-content" class="modal-content relative bg-gray-800 rounded-2xl w-full max-w-sm p-5 shadow-lg flex flex-col h-[90vh]">
            <h2 class="text-lg font-bold text-center mb-4 flex-shrink-0">警長選舉設定</h2>
            <div id="sheriff-options" class="flex-grow overflow-y-auto"></div>
            <div class="mt-4 flex space-x-2 flex-shrink-0">
                <button id="reset-sheriff-btn" class="w-1/2 bg-red-800 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">重設警選</button>
                <button id="close-sheriff-modal-btn" class="w-1/2 bg-blue-700 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">完成</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // DOM element selections
            const leftColumn = document.getElementById('left-column');
            const rightColumn = document.getElementById('right-column');
            const modal = document.getElementById('modal');
            const modalBackdrop = document.getElementById('modal-backdrop');
            const modalTitle = document.getElementById('modal-title');
            const modalOptions = document.getElementById('modal-options');
            const tagsOptions = document.getElementById('tags-options');
            const closeModalBtn = document.getElementById('close-modal-btn');
            const resetBtn = document.getElementById('reset-btn');
            const sheriffBtn = document.getElementById('sheriff-btn');
            const sheriffModal = document.getElementById('sheriff-modal');
            const sheriffModalBackdrop = document.getElementById('sheriff-modal-backdrop');
            const sheriffOptions = document.getElementById('sheriff-options');
            const closeSheriffModalBtn = document.getElementById('close-sheriff-modal-btn');
            const resetSheriffBtn = document.getElementById('reset-sheriff-btn');
            const sheriffDisplay = document.getElementById('sheriff-display');
            const tieBreakerBtn = document.getElementById('tie-breaker-btn');
            const tieBreakerModal = document.getElementById('tie-breaker-modal');
            const tieBreakerModalBackdrop = document.getElementById('tie-breaker-modal-backdrop');
            const tieBreakerOptions = document.getElementById('tie-breaker-options');
            const closeTieBreakerBtn = document.getElementById('close-tie-breaker-btn');
            const resetTieBreakerBtn = document.getElementById('reset-tie-breaker-btn');
            const tieBreakerDisplay = document.getElementById('tie-breaker-display');


            let gameState = {};
            let currentEditingPlayerId = null;

            // Tags configuration
            const tagDefinitions = {
                '狼': { name: '狼' },
                '大狼': { name: '大狼' },
                '其他狼': { name: '其他狼' },
                '預言家': { name: '預言家' },
                '女巫': { name: '女巫' },
                '獵人': { name: '獵人' },
                '神牌': { name: '神牌' },
                '偏好': { name: '偏好' },
                '平民': { name: '平民' },
                '金水': { name: '金水' },
                '銀水': { name: '銀水' },
                '好人': { name: '好人', isGoodPerson: true },
                '狼人': { name: '狼人', isWolfSlot: true },
            };
            
            const tagLayout = [
                ['狼', '大狼', '其他狼'],
                ['預言家', '女巫', '獵人', '神牌'],
                ['偏好', '平民', '金水', '銀水']
            ];


            // Initialize or load data from localStorage
            function initialize() {
                const savedData = localStorage.getItem('werewolfNotepadState');
                if (savedData) {
                    gameState = JSON.parse(savedData);
                    // Backward compatibility and data integrity checks
                    if (!gameState.sheriff) gameState.sheriff = { running: [], votes: {} };
                    if (!gameState.sheriffTieBreaker) gameState.sheriffTieBreaker = { tiedPlayers: [], votes: {} };
                    
                    gameState.players.forEach(p => {
                        if(p.isMe === undefined) p.isMe = false;
                        if(p.isStarred === undefined) p.isStarred = false;
                    });

                } else {
                    gameState = {
                        players: Array.from({ length: 12 }, (_, i) => ({
                            id: i + 1,
                            status: 'alive',
                            tags: [],
                            isMe: false,
                            isStarred: false
                        })),
                        sheriff: { running: [], votes: {} },
                        sheriffTieBreaker: { tiedPlayers: [], votes: {} },
                    };
                }
                render();
            }

            // Save data to localStorage
            function saveData() {
                localStorage.setItem('werewolfNotepadState', JSON.stringify(gameState));
            }

            // Render all UI components
            function render() {
                renderPlayers();
                renderSheriffInfo();
                renderTieBreakerInfo();
            }
            
            // Render player grid
            function renderPlayers() {
                leftColumn.innerHTML = '';
                rightColumn.innerHTML = '';

                gameState.players.forEach(player => {
                    const isWolfSlot = player.tags.some(tagId => tagDefinitions[tagId] && tagDefinitions[tagId].isWolfSlot);
                    const isGoodPerson = player.tags.some(tagId => tagDefinitions[tagId] && tagDefinitions[tagId].isGoodPerson);
                    const isMe = player.isMe;
                    const isStarred = player.isStarred;

                    const card = document.createElement('div');
                    let cardClasses = `player-card bg-gray-800 rounded-lg p-2 flex flex-col justify-between items-center cursor-pointer ${player.status === 'eliminated' ? 'eliminated' : ''}`;
                    if (isWolfSlot) {
                        cardClasses += ' is-wolf-slot';
                    } else if (isGoodPerson) {
                        cardClasses += ' is-good-person';
                    }
                    card.className = cardClasses;
                    card.dataset.playerId = player.id;
                    
                    const tagsHTML = player.tags
                        .filter(tagId => tagId !== '好人' && tagId !== '狼人') 
                        .map(tagId => tagDefinitions[tagId] ? `<span class="tag">${tagId}</span>` : '')
                        .join('');

                    const isLeftColumnPlayer = player.id <= 6;
                    const emojiPositionClass = isLeftColumnPlayer ? 'bottom-1 left-1' : 'bottom-1 right-1';
                    const meEmojiHTML = isMe ? `<span class="absolute ${emojiPositionClass} text-xl z-10">🙎🏻‍♂️</span>` : '';
                    const starHTML = isStarred ? `<span class="absolute top-0 -right-4 text-lg z-10">☀️</span>` : '';


                    card.innerHTML = `
                        <button class="reset-player-btn absolute top-1 left-1 text-gray-500 hover:text-white z-10 p-1">
                          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1-6.74 2.74L21 8"/><path d="M21 3v5h-5"/></svg>
                        </button>
                        <button class="eliminate-btn absolute top-1 right-1 text-gray-500 hover:text-white z-10 p-1">
                          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
                        </button>
                        <div class="player-number-wrapper inline-block relative">
                            <div class="player-number text-5xl font-bold">${player.id}</div>
                            ${starHTML}
                        </div>
                        <div class="tags-container flex flex-wrap justify-center min-h-[24px]">${tagsHTML}</div>
                        ${meEmojiHTML}
                    `;
                    
                    if (isLeftColumnPlayer) {
                        leftColumn.appendChild(card);
                    } else {
                        rightColumn.appendChild(card);
                    }
                });
            }
            
            // Render sheriff election info
            function renderSheriffInfo() {
                const { running, votes } = gameState.sheriff;
                // If no one is running, don't display anything.
                if (running.length === 0) {
                    sheriffDisplay.innerHTML = '';
                    return;
                }

                const notRunning = gameState.players.map(p => p.id).filter(id => !running.includes(id));
                
                const runningText = `<div><span class="font-semibold">警上：</span>${running.join(' ')}</div>`;
                const notRunningText = notRunning.length > 0 ? `<div><span class="font-semibold">警下：</span>${notRunning.join(' ')}</div>` : '';

                const votesByCandidate = {};
                // Iterate over all possible voters (警下) to determine their vote or abstention
                notRunning.forEach(voterId => {
                    const votedFor = votes[voterId];
                    const candidate = votedFor ? votedFor : 'abstain'; // If no vote recorded, it's an abstention
                    
                    if (!votesByCandidate[candidate]) {
                        votesByCandidate[candidate] = [];
                    }
                    votesByCandidate[candidate].push(String(voterId));
                });

                let votesText = '';
                if (notRunning.length > 0) {
                    votesText += '<div><span class="font-semibold">投票：</span>';
                    
                    const voteStrings = [];
                    const sortedCandidates = Object.keys(votesByCandidate).sort((a, b) => {
                        if (a === 'abstain') return 1;
                        if (b === 'abstain') return -1;
                        return parseInt(a) - parseInt(b);
                    });

                    sortedCandidates.forEach(candidate => {
                        const voters = votesByCandidate[candidate];
                        if (voters && voters.length > 0) {
                            const sortedVoters = voters.sort((a,b) => parseInt(a) - parseInt(b)).join(' ');
                            if (candidate === 'abstain') {
                                voteStrings.push(`${sortedVoters} 棄票`);
                            } else {
                                voteStrings.push(`${sortedVoters} 投 ${candidate}`);
                            }
                        }
                    });

                    votesText += voteStrings.join('； ');
                    votesText += '</div>';
                }

                sheriffDisplay.innerHTML = runningText + notRunningText + votesText;
            }

            // Render tie-breaker info
            function renderTieBreakerInfo() {
                const { tiedPlayers, votes } = gameState.sheriffTieBreaker;
                if (tiedPlayers.length === 0) {
                    tieBreakerDisplay.innerHTML = '';
                    return;
                }

                let html = '<div class="border-t border-gray-700 mt-2 pt-2">';
                html += `<div><span class="font-semibold text-purple-400">平票PK玩家：</span>${tiedPlayers.join(' ')}</div>`;
                
                const votesByCandidate = {};
                Object.entries(votes).forEach(([voter, candidate]) => {
                    if (candidate) {
                        if (!votesByCandidate[candidate]) {
                            votesByCandidate[candidate] = [];
                        }
                        votesByCandidate[candidate].push(voter);
                    }
                });

                const allPossibleVoters = gameState.players
                    .filter(p => !tiedPlayers.includes(p.id))
                    .map(p => p.id);
                const actualVoters = Object.keys(votes).map(v => parseInt(v));
                const abstainers = allPossibleVoters.filter(voterId => !actualVoters.includes(voterId));

                if (actualVoters.length > 0 || abstainers.length > 0) {
                    html += `<div><span class="font-semibold text-purple-400">PK投票：</span>`;
                    
                    const voteStrings = [];
                    
                    Object.entries(votesByCandidate).forEach(([candidate, voters]) => {
                        voteStrings.push(`${voters.sort((a,b) => a-b).join(' ')} 投 ${candidate}`);
                    });

                    if (abstainers.length > 0) {
                        voteStrings.push(`${abstainers.sort((a,b) => a-b).join(' ')} 棄票`);
                    }

                    html += voteStrings.join('； ');
                    html += `</div>`;
                }
                
                html += '</div>';
                tieBreakerDisplay.innerHTML = html;
            }

            // Generic modal open/close functions
            function openGenericModal(modalElement) {
                modalElement.classList.remove('hidden');
                setTimeout(() => modalElement.classList.remove('modal-closed'), 10);
            }

            function closeGenericModal(modalElement) {
                modalElement.classList.add('modal-closed');
                setTimeout(() => modalElement.classList.add('hidden'), 200);
            }

            // Open player tagging modal
            function openTagModal(playerId) {
                currentEditingPlayerId = playerId;
                const player = gameState.players.find(p => p.id === currentEditingPlayerId);
                if (!player) return;

                modalTitle.textContent = `標記 ${playerId} 號玩家`;
                
                const isGoodPerson = player.tags.includes('好人');
                const isWolfSlot = player.tags.includes('狼人');

                // Top row buttons
                modalOptions.innerHTML = `
                    <div class="flex space-x-2 mb-4 border-b border-gray-700 pb-3">
                        <button id="set-me-btn" class="w-1/4 py-2 px-2 rounded-lg text-white font-semibold text-2xl ${player.isMe ? 'bg-green-600 selected' : 'bg-gray-600'}">
                        🙎🏻‍♂️
                        </button>
                        <button id="set-star-btn" class="w-1/4 py-2 px-2 rounded-lg text-white font-semibold text-2xl ${player.isStarred ? 'bg-yellow-600 selected' : 'bg-gray-600'}">
                        ☀️
                        </button>
                        <button id="set-good-person-btn" class="w-1/4 py-2 px-2 rounded-lg text-white font-semibold ${isGoodPerson ? 'bg-green-700 selected' : 'bg-gray-600'}">
                        好人
                        </button>
                        <button id="set-wolf-slot-btn" class="w-1/4 py-2 px-2 rounded-lg text-white font-semibold ${isWolfSlot ? 'bg-red-800 selected' : 'bg-gray-600'}">
                        狼人
                        </button>
                    </div>`;
                
                // Render tags in rows
                tagsOptions.innerHTML = '';
                tagLayout.forEach(row => {
                    const rowDiv = document.createElement('div');
                    rowDiv.className = "flex flex-wrap justify-center gap-2";
                    row.forEach(tagId => {
                        const tag = tagDefinitions[tagId];
                        const button = document.createElement('button');
                        button.className = `tag-btn bg-gray-600 hover:bg-gray-500 text-white font-medium py-2 px-3 rounded-lg text-sm flex-grow ${player.tags.includes(tagId) ? 'selected' : ''}`;
                        button.textContent = tag.name;
                        button.dataset.tagId = tagId;
                        rowDiv.appendChild(button);
                    });
                    tagsOptions.appendChild(rowDiv);
                });
                
                openGenericModal(modal);
            }
            
            // Open sheriff election modal
            function openSheriffModal() {
                renderSheriffModalContent();
                openGenericModal(sheriffModal);
            }
            
            // Open tie-breaker modal
            function openTieBreakerModal() {
                renderTieBreakerModalContent();
                openGenericModal(tieBreakerModal);
            }

            // Render sheriff election modal content
            function renderSheriffModalContent() {
                sheriffOptions.innerHTML = '';
                const { running } = gameState.sheriff;

                // Section for players running for sheriff
                const runningSection = document.createElement('div');
                runningSection.innerHTML = `<h3 class="text-md font-bold text-yellow-400 mb-2 border-b border-gray-600 pb-1">警上玩家 (點擊加入/移除)</h3>`;
                const runningGrid = document.createElement('div');
                runningGrid.className = 'grid grid-cols-4 gap-2 mb-4';
                gameState.players.forEach(p => {
                    const btn = document.createElement('button');
                    btn.className = `sheriff-player-btn py-2 rounded-lg ${running.includes(p.id) ? 'bg-yellow-600 selected' : 'bg-gray-600'}`;
                    btn.textContent = p.id;
                    btn.dataset.playerId = p.id;
                    runningGrid.appendChild(btn);
                });
                runningSection.appendChild(runningGrid);
                sheriffOptions.appendChild(runningSection);

                // Section for voting
                const notRunningPlayers = gameState.players.filter(p => !running.includes(p.id));
                if (notRunningPlayers.length > 0) {
                    const votingSection = document.createElement('div');
                    votingSection.innerHTML = `<h3 class="text-md font-bold text-blue-400 mb-2 border-b border-gray-600 pb-1">警下投票</h3>`;
                    const votingList = document.createElement('div');
                    votingList.className = 'space-y-2';
                    notRunningPlayers.forEach(p => {
                        const voteItem = document.createElement('div');
                        voteItem.className = 'flex items-center justify-between';
                        voteItem.innerHTML = `<span class="font-bold mr-4">${p.id} 號</span>`;
                        const select = document.createElement('select');
                        select.className = 'vote-select';
                        select.dataset.voterId = p.id;
                        
                        // Options
                        select.innerHTML = `<option value="">未投票</option>`;
                        running.forEach(candidateId => {
                           select.innerHTML += `<option value="${candidateId}" ${gameState.sheriff.votes[p.id] == candidateId ? 'selected' : ''}>投 ${candidateId} 號</option>`;
                        });
                        select.innerHTML += `<option value="abstain" ${gameState.sheriff.votes[p.id] === 'abstain' ? 'selected' : ''}>棄票</option>`;
                        
                        voteItem.appendChild(select);
                        votingList.appendChild(voteItem);
                    });
                    votingSection.appendChild(votingList);
                    sheriffOptions.appendChild(votingSection);
                }
            }
            
            // Render tie-breaker modal content (New UI)
            function renderTieBreakerModalContent() {
                tieBreakerOptions.innerHTML = '';
                const { tiedPlayers, votes } = gameState.sheriffTieBreaker;

                // Section for tied players
                const tiedSection = document.createElement('div');
                tiedSection.innerHTML = `<h3 class="text-md font-bold text-purple-400 mb-2 border-b border-gray-600 pb-1">PK玩家 (點擊加入/移除)</h3>`;
                const tiedGrid = document.createElement('div');
                tiedGrid.className = 'grid grid-cols-4 gap-2 mb-4';
                gameState.players.forEach(p => {
                    const btn = document.createElement('button');
                    btn.className = `sheriff-player-btn py-2 rounded-lg ${tiedPlayers.includes(p.id) ? 'bg-purple-600 selected' : 'bg-gray-600'}`;
                    btn.textContent = p.id;
                    btn.dataset.playerId = p.id;
                    tiedGrid.appendChild(btn);
                });
                tiedSection.appendChild(tiedGrid);
                tieBreakerOptions.appendChild(tiedSection);

                // Section for PK voting
                const voters = gameState.players.filter(p => !tiedPlayers.includes(p.id));
                if (voters.length > 0 && tiedPlayers.length > 0) {
                    const votingContainer = document.createElement('div');
                    
                    tiedPlayers.forEach(candidateId => {
                        const candidateSection = document.createElement('div');
                        candidateSection.className = 'mb-4';
                        candidateSection.innerHTML = `<h3 class="text-md font-bold text-blue-400 mb-2 border-b border-gray-600 pb-1">投票給 ${candidateId} 號</h3>`;
                        
                        const votersGrid = document.createElement('div');
                        votersGrid.className = 'grid grid-cols-5 gap-2';

                        voters.forEach(voter => {
                            const btn = document.createElement('button');
                            const isSelected = votes[voter.id] === candidateId;
                            btn.className = `vote-btn py-2 rounded-lg ${isSelected ? 'bg-blue-600 selected' : 'bg-gray-600'}`;
                            btn.textContent = voter.id;
                            btn.dataset.voterId = voter.id;
                            btn.dataset.candidateId = candidateId;
                            votersGrid.appendChild(btn);
                        });

                        candidateSection.appendChild(votersGrid);
                        votingContainer.appendChild(candidateSection);
                    });
                    
                    tieBreakerOptions.appendChild(votingContainer);
                }
            }


            // Event Listeners
            document.getElementById('players-grid').addEventListener('click', (e) => {
                const card = e.target.closest('.player-card');
                if (!card) return;
                const playerId = parseInt(card.dataset.playerId);

                if (e.target.closest('.reset-player-btn')) {
                    const player = gameState.players.find(p => p.id === playerId);
                    if (player) {
                        player.tags = [];
                        player.status = 'alive';
                        player.isMe = false;
                        player.isStarred = false;
                        saveData();
                        render();
                    }
                    return;
                }
                if (e.target.closest('.eliminate-btn')) {
                    const player = gameState.players.find(p => p.id === playerId);
                    if (player) {
                        player.status = player.status === 'alive' ? 'eliminated' : 'alive';
                        saveData();
                        render();
                    }
                    return;
                }
                openTagModal(playerId);
            });
            
            modal.addEventListener('click', (e) => {
                const player = gameState.players.find(p => p.id === currentEditingPlayerId);
                if (!player) return;

                // "Me" button listener
                const setMeBtn = e.target.closest('#set-me-btn');
                if (setMeBtn) {
                    player.isMe = !player.isMe;
                    setMeBtn.classList.toggle('selected', player.isMe);
                    setMeBtn.classList.toggle('bg-green-600', player.isMe);
                    setMeBtn.classList.toggle('bg-gray-600', !player.isMe);
                    saveData();
                    return;
                }
                
                // "Star" button listener
                const setStarBtn = e.target.closest('#set-star-btn');
                if (setStarBtn) {
                    player.isStarred = !player.isStarred;
                    setStarBtn.classList.toggle('selected', player.isStarred);
                    setStarBtn.classList.toggle('bg-yellow-600', player.isStarred);
                    setStarBtn.classList.toggle('bg-gray-600', !player.isStarred);
                    saveData();
                    return;
                }

                // "Good Person" button listener
                const setGoodPersonBtn = e.target.closest('#set-good-person-btn');
                if (setGoodPersonBtn) {
                    const tagId = '好人';
                    if (player.tags.includes(tagId)) {
                        player.tags = player.tags.filter(t => t !== tagId);
                    } else {
                        player.tags.push(tagId);
                    }
                    const isGoodPerson = player.tags.includes(tagId);
                    setGoodPersonBtn.classList.toggle('selected', isGoodPerson);
                    setGoodPersonBtn.classList.toggle('bg-green-700', isGoodPerson);
                    setGoodPersonBtn.classList.toggle('bg-gray-600', !isGoodPerson);
                    saveData();
                    return;
                }
                
                // "Wolf Slot" button listener
                const setWolfSlotBtn = e.target.closest('#set-wolf-slot-btn');
                if (setWolfSlotBtn) {
                    const tagId = '狼人';
                    if (player.tags.includes(tagId)) {
                        player.tags = player.tags.filter(t => t !== tagId);
                    } else {
                        player.tags.push(tagId);
                    }
                    const isWolfSlot = player.tags.includes(tagId);
                    setWolfSlotBtn.classList.toggle('selected', isWolfSlot);
                    setWolfSlotBtn.classList.toggle('bg-red-800', isWolfSlot);
                    setWolfSlotBtn.classList.toggle('bg-gray-600', !isWolfSlot);
                    saveData();
                    return;
                }


                // Tag button listener
                const button = e.target.closest('.tag-btn');
                if (button) {
                    const tagId = button.dataset.tagId;
                    if (player.tags.includes(tagId)) {
                        player.tags = player.tags.filter(t => t !== tagId);
                        button.classList.remove('selected');
                    } else {
                        player.tags.push(tagId);
                        button.classList.add('selected');
                    }
                    saveData();
                }
            });


            // Sheriff Modal Events
            sheriffOptions.addEventListener('click', (e) => {
                const btn = e.target.closest('.sheriff-player-btn');
                if (!btn) return;
                const playerId = parseInt(btn.dataset.playerId);
                const running = gameState.sheriff.running;
                if (running.includes(playerId)) {
                    gameState.sheriff.running = running.filter(id => id !== playerId);
                    Object.keys(gameState.sheriff.votes).forEach(voter => {
                        if (gameState.sheriff.votes[voter] === playerId) {
                            delete gameState.sheriff.votes[voter];
                        }
                    });
                } else {
                    running.push(playerId);
                    running.sort((a, b) => a - b);
                }
                renderSheriffModalContent();
            });

            sheriffOptions.addEventListener('change', (e) => {
                const select = e.target.closest('.vote-select');
                if (!select) return;
                const voterId = select.dataset.voterId;
                const candidate = select.value;
                if (candidate) {
                    gameState.sheriff.votes[voterId] = candidate === 'abstain' ? 'abstain' : parseInt(candidate);
                } else {
                    delete gameState.sheriff.votes[voterId];
                }
            });

            resetSheriffBtn.addEventListener('click', () => {
                gameState.sheriff.running = [];
                gameState.sheriff.votes = {};
                gameState.sheriffTieBreaker = { tiedPlayers: [], votes: {} };
                renderSheriffModalContent();
            });

            // Tie-Breaker Modal Events
             tieBreakerOptions.addEventListener('click', (e) => {
                // Handle PK player selection
                const playerBtn = e.target.closest('.sheriff-player-btn');
                if (playerBtn) {
                    const playerId = parseInt(playerBtn.dataset.playerId);
                    const tied = gameState.sheriffTieBreaker.tiedPlayers;
                    if (tied.includes(playerId)) {
                        gameState.sheriffTieBreaker.tiedPlayers = tied.filter(id => id !== playerId);
                        // Clean up votes for the removed candidate
                        Object.keys(gameState.sheriffTieBreaker.votes).forEach(voter => {
                            if (gameState.sheriffTieBreaker.votes[voter] === playerId) {
                                delete gameState.sheriffTieBreaker.votes[voter];
                            }
                        });
                    } else {
                        tied.push(playerId);
                        tied.sort((a, b) => a - b);
                    }
                    renderTieBreakerModalContent();
                    return; // Stop further execution
                }

                // Handle PK voting
                const voteBtn = e.target.closest('.vote-btn');
                if (voteBtn) {
                    const voterId = parseInt(voteBtn.dataset.voterId);
                    const candidateId = parseInt(voteBtn.dataset.candidateId);
                    const currentVote = gameState.sheriffTieBreaker.votes[voterId];

                    if (currentVote === candidateId) {
                        // Click again to unvote
                        delete gameState.sheriffTieBreaker.votes[voterId];
                    } else {
                        // Vote for this candidate
                        gameState.sheriffTieBreaker.votes[voterId] = candidateId;
                    }
                    renderTieBreakerModalContent(); // Re-render to show selection change
                }
            });

            resetTieBreakerBtn.addEventListener('click', () => {
                gameState.sheriffTieBreaker = { tiedPlayers: [], votes: {} };
                renderTieBreakerModalContent();
            });


            // General Button Events
            sheriffBtn.addEventListener('click', openSheriffModal);
            
            tieBreakerBtn.addEventListener('click', () => {
                // Auto-detect tied players from the first round of sheriff voting
                const { votes } = gameState.sheriff;
                const voteCounts = {};
                
                Object.values(votes).forEach(candidate => {
                    if (candidate && candidate !== 'abstain') {
                        voteCounts[candidate] = (voteCounts[candidate] || 0) + 1;
                    }
                });

                let maxVotes = 0;
                Object.values(voteCounts).forEach(count => {
                    if (count > maxVotes) {
                        maxVotes = count;
                    }
                });

                const tiedPlayers = [];
                if (maxVotes > 0) {
                    Object.keys(voteCounts).forEach(candidate => {
                        if (voteCounts[candidate] === maxVotes) {
                            tiedPlayers.push(parseInt(candidate));
                        }
                    });
                }

                if (tiedPlayers.length > 1) {
                    gameState.sheriffTieBreaker.tiedPlayers = tiedPlayers.sort((a, b) => a - b);
                    // Reset previous PK votes when setting new tied players
                    gameState.sheriffTieBreaker.votes = {};
                }
                
                openTieBreakerModal();
            });


            closeModalBtn.addEventListener('click', () => {
                render(); // Re-render main grid when closing tag modal
                closeGenericModal(modal);
            });
            modalBackdrop.addEventListener('click', () => {
                 render(); // Re-render main grid when closing tag modal
                closeGenericModal(modal);
            });
            
            closeSheriffModalBtn.addEventListener('click', () => {
                saveData();
                render();
                closeGenericModal(sheriffModal);
            });
            sheriffModalBackdrop.addEventListener('click', () => {
                saveData();
                render();
                closeGenericModal(sheriffModal);
            });
            
            closeTieBreakerBtn.addEventListener('click', () => {
                saveData();
                render();
                closeGenericModal(tieBreakerModal);
            });
            tieBreakerModalBackdrop.addEventListener('click', () => {
                saveData();
                render();
                closeGenericModal(tieBreakerModal);
            });
            
            resetBtn.addEventListener('click', () => {
                // The confirm() function is not used because it is not supported in the execution environment.
                localStorage.removeItem('werewolfNotepadState');
                initialize();
            });

            initialize();
        });
    </script>
</body>
</html>
